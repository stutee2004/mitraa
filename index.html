<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MITRAA | Your Soulful AI Friend</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;700;900&family=Poppins:wght@300;400;600&display=swap');

        :root {
            --saffron-soft: #F4A460;
            --saffron-bright: #FF8C00;
            --saffron-glow: rgba(244, 164, 96, 0.4);
            --terracotta: #CD5C5C;
            --deep-teal: #2D5A56;
            --sage: #A3B18A;
            --clay-bg: #fdf6ec; 
            --warm-shadow: rgba(45, 90, 86, 0.12);
            --gold-leaf: #D4AF37;
            --mood-color: var(--saffron-bright);
            --peace-pink: #FFF0F5;
            --peace-border: #FFB6C1;
        }

        html, body {
            height: auto;
            min-height: 100%;
            overflow-y: auto; 
            background-color: var(--clay-bg);
            background-image: url("https://www.transparenttextures.com/patterns/natural-paper.png");
            margin: 0;
            font-family: 'Poppins', sans-serif;
            color: #3E3E3E;
            transition: background-color 2s ease, filter 2s ease, box-shadow 2s ease, transform 2s ease-in-out;
        }

        /* ENHANCED PRANAYAMA BREATHING EFFECT */
        @keyframes pranaPulse {
            0% { background-color: var(--clay-bg); transform: scale(1); }
            50% { background-color: #e8f3f1; box-shadow: inset 0 0 150px rgba(45, 90, 86, 0.2); transform: scale(1.015); }
            100% { background-color: var(--clay-bg); transform: scale(1); }
        }
        .pulsing { animation: pranaPulse 4s ease-in-out infinite !important; }

        /* SIDEBAR GLOW EFFECT */
        @keyframes sidebarPeaceGlow {
            0% { box-shadow: 0 0 20px rgba(255, 182, 193, 0.2); }
            50% { box-shadow: 0 0 50px rgba(255, 182, 193, 0.6); }
            100% { box-shadow: 0 0 20px rgba(255, 182, 193, 0.2); }
        }
        .sidebar-glow-active {
            animation: sidebarPeaceGlow 3s infinite ease-in-out;
            transition: 0.5s;
        }

        /* FALLING ELEMENTS ANIMATION */
        .falling-item {
            position: fixed;
            top: -100px;
            pointer-events: none;
            z-index: 5000;
            user-select: none;
            animation: fall linear forwards;
        }

        .sparkle-dot {
            position: absolute;
            width: 6px;
            height: 6px;
            background: #FFD700;
            border-radius: 50%;
            box-shadow: 0 0 15px 5px rgba(255, 215, 0, 0.8);
            animation: twinkle 0.8s infinite alternate;
        }

        @keyframes fall {
            0% { transform: translateY(0) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(120vh) rotate(720deg); opacity: 0; }
        }

        @keyframes twinkle {
            from { opacity: 0.4; transform: scale(0.6); }
            to { opacity: 1; transform: scale(1.3); }
        }

        /* MOOD SELECTOR STYLING - CENTERED */
        .mood-selector {
            display: flex;
            justify-content: space-evenly; 
            align-items: center;
            padding: 15px 0;
            margin-bottom: 10px;
        }

        .mood-flame { 
            font-size: 1.5rem; 
            cursor: pointer; 
            transition: 0.4s; 
            opacity: 0.6; 
            filter: saturate(0.8);
        }
        .mood-flame.active { 
            opacity: 1; 
            filter: saturate(1.5) drop-shadow(0 0 15px currentColor); 
            transform: scale(1.5); 
        }

        /* DIYA OVERLAY ANIMATIONS */
        @keyframes diyaGlow {
            0% { filter: drop-shadow(0 0 30px var(--mood-color)) brightness(1); transform: scale(1); }
            50% { filter: drop-shadow(0 0 60px gold) drop-shadow(0 0 100px var(--mood-color)) brightness(1.3); transform: scale(1.05); }
            100% { filter: drop-shadow(0 0 30px var(--mood-color)) brightness(1); transform: scale(1); }
        }

        .big-diya-shine {
            animation: diyaGlow 2.5s infinite ease-in-out;
        }

        .diya-sparkle {
            position: absolute;
            pointer-events: none;
            background: white;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            box-shadow: 0 0 12px #fff;
            z-index: 2005;
        }

        body.diya-lit { background-color: #fff0db; filter: brightness(1.08); }
        body.zen-active .hero-banner, body.zen-active .wellness-sidebar { display: none; }
        body.zen-active .main-wrapper { justify-content: center; }
        body.zen-active .chat-container { max-width: 800px; flex: none; width: 100%; }

        #disclaimerOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .disclaimer-card { background: white; width: 90%; max-width: 500px; padding: 40px; border-radius: 30px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.3); border-top: 8px solid var(--saffron-soft); }
        .disclaimer-card h2 { font-family: 'Crimson Pro', serif; color: var(--deep-teal); }
        .agree-btn { background: var(--deep-teal); color: white; border: none; padding: 12px 40px; border-radius: 30px; font-weight: 600; cursor: pointer; transition: 0.3s; }

        nav { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(5px); padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #EAE0D5; position: sticky; top: 0; z-index: 1000; }
        .logo-text { font-weight: 900; color: var(--deep-teal); font-family: 'Crimson Pro', serif; font-size: 1.8rem; letter-spacing: 1px; }
        .nav-tools { display: flex; align-items: center; gap: 15px; }
        .tool-icon { cursor: pointer; color: var(--deep-teal); font-size: 1.2rem; transition: 0.3s; }
        .tool-icon:hover { transform: scale(1.2); }

        #moodHistorySidebar { position: fixed; right: -350px; top: 0; width: 320px; height: 100%; background: white; box-shadow: -5px 0 30px rgba(0,0,0,0.1); transition: 0.5s ease; z-index: 4000; padding: 30px; overflow-y: auto; }
        #moodHistorySidebar.active { right: 0; }
        .history-item { display: flex; align-items: center; gap: 15px; padding: 12px; border-bottom: 1px solid #f0e6d8; font-size: 0.9rem; }

        .hero-banner { text-align: center; padding: 60px 20px; background: linear-gradient(to bottom, #ffffff, var(--clay-bg)); border-bottom: 1px solid #F0E6D8; }
        .hero-banner h1 { font-family: 'Crimson Pro', serif; font-size: 7rem; margin: 0; color: var(--deep-teal); font-weight: 900; letter-spacing: -4px; line-height: 0.9; }
        .hero-subtitle { color: var(--terracotta); margin-top: 10px; letter-spacing: 4px; text-transform: uppercase; font-size: 0.9rem; font-weight: 600; }
        .main-wrapper { display: flex; padding: 40px 5%; gap: 40px; max-width: 1400px; margin: 0 auto; flex-wrap: wrap; }
        .wellness-sidebar { flex: 1; min-width: 320px; display: flex; flex-direction: column; gap: 20px; }
        .card { background: rgba(255, 255, 255, 0.9); padding: 25px; border-radius: 24px; box-shadow: 0 10px 30px var(--warm-shadow); border: 1px solid rgba(234, 224, 213, 0.8); position: relative; }

        .diya-btn { background: #FFFBF0; border: 2px solid var(--saffron-soft); padding: 15px; border-radius: 18px; width: 100%; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 12px; font-weight: 700; color: var(--deep-teal); transition: 0.3s; overflow: hidden; position: relative; }
        .diya-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, rgba(255,248,230,0.85) 0%, rgba(0,0,0,0.4) 100%); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .big-diya-container { display: flex; flex-direction: column; align-items: center; position: relative; }
        .big-diya { font-size: 180px; transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        .travel-spark { position: fixed; width: 25px; height: 25px; background: gold; border-radius: 50%; box-shadow: 0 0 20px 5px var(--mood-color); z-index: 2001; pointer-events: none; display: none; }
        .soul-note { border: 1px solid #f0e6d8; border-radius: 15px; width: 100%; padding: 10px; font-family: 'Poppins', sans-serif; height: 100px; resize: none; background: #fffcf9; font-size: 0.9rem; margin-top: 10px; outline: none; transition: 0.3s; }

        .chat-container { flex: 2; min-width: 450px; min-height: 650px; background: rgba(255, 255, 255, 0.8); border-radius: 30px; display: flex; flex-direction: column; box-shadow: 0 15px 50px var(--warm-shadow); border: 2px solid #EAE0D5; overflow: hidden; }
        .chat-header { padding: 15px 25px; border-bottom: 2px solid #F0E6D8; display: flex; justify-content: space-between; align-items: center; background: rgba(255, 255, 255, 0.5); }
        .chat-messages { flex: 1; padding: 35px; overflow-y: auto; background-image: url('https://www.transparenttextures.com/patterns/natural-paper.png'); }
        .bubble { margin-bottom: 25px; padding: 18px 25px; border-radius: 22px; max-width: 80%; line-height: 1.7; box-shadow: 2px 4px 10px rgba(0,0,0,0.03); position: relative; }
        .mitra-bubble { background: #ffffff; border: 1px solid #f0e6d8; border-left: 5px solid var(--saffron-soft); }
        .user-bubble { background: var(--deep-teal); color: white; margin-left: auto; }
        .rangoli-loader { width: 30px; height: 30px; border: 3px solid var(--gold-leaf); border-top: 3px solid var(--terracotta); border-radius: 50%; animation: spin 2s linear infinite; display: none; margin-left: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .chat-input-area { padding: 20px 30px; background: #fff; border-top: 2px solid #F0E6D8; display: flex; flex-direction: column; gap: 10px; }
        .input-row { display: flex; gap: 15px; align-items: center; }
        .chat-input-area input { flex: 1; border: 2px solid #EAE0D5; padding: 18px 25px; border-radius: 35px; outline: none; font-size: 1rem; background: #fafafa; transition: 0.3s; }
        
        .voice-btn { background: var(--sage); position: relative; }
        .voice-btn.recording { background: #ff4b2b !important; animation: voicePulse 1s infinite alternate; }
        @keyframes voicePulse { 0% { transform: scale(1); box-shadow: 0 0 0px red; } 100% { transform: scale(1.15); box-shadow: 0 0 25px rgba(255, 0, 0, 0.5); } }

        .icon-btn { background: var(--terracotta); color: white; border: none; width: 55px; height: 55px; border-radius: 50%; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .sos-floating { position: fixed; bottom: 30px; right: 30px; background: #B22222; color: white; padding: 15px 30px; border-radius: 50px; font-weight: 700; z-index: 999; border: none; box-shadow: 0 5px 15px rgba(178, 34, 34, 0.4); }

        /* QUOTE BOX STYLES */
        .quote-box {
            background: linear-gradient(to right, #ffffff, #fffdfa);
            border-left: 4px solid var(--gold-leaf);
            font-family: 'Crimson Pro', serif;
            text-align: center;
        }
        .quote-text {
            font-size: 1.1rem;
            color: var(--deep-teal);
            font-style: italic;
            margin-bottom: 10px;
        }
        .quote-author {
            font-size: 0.8rem;
            color: var(--terracotta);
            letter-spacing: 2px;
            font-weight: 700;
        }

        /* SOULFUL REACTION STYLES */
        .reaction-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        .reaction-meaning {
            font-size: 0.65rem;
            color: #7a7a7a;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .feedback-container {
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
        }
        .bling-emoji {
            font-size: 1.8rem;
            cursor: pointer;
            transition: 0.3s;
            position: relative;
        }
        .bling-emoji:hover { transform: scale(1.3); }

        @keyframes blingEffect {
            0% { transform: scale(1) rotate(0); opacity: 1; }
            50% { transform: scale(2.2) rotate(15deg); opacity: 0.9; filter: drop-shadow(0 0 15px gold); }
            100% { transform: scale(1) rotate(0); opacity: 1; }
        }
        .bling-active { animation: blingEffect 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

    </style>
</head>
<body onload="initBest()">

<div id="disclaimerOverlay">
    <div class="disclaimer-card">
        <i class="fas fa-hand-holding-heart" style="font-size: 3rem; color: var(--saffron-soft); margin-bottom: 15px;"></i>
        <h2>A Shared Sankalpa (Commitment)</h2>
        <p>Welcome to <b>Mitraa</b>. I am an AI companion designed to offer support. <br><br> Remember: <b>I am not a doctor.</b> If you are in immediate danger, please use the SOS button.</p>
        <button class="agree-btn" onclick="acceptDisclaimer()">I Understand & Enter</button>
    </div>
</div>

<div id="moodHistorySidebar">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h3 style="font-family:'Crimson Pro', serif; color:var(--deep-teal); margin:0;">Soul Log</h3>
        <i class="fas fa-times" style="cursor:pointer;" onclick="toggleHistory()"></i>
    </div>
    <div id="historyList"></div>
</div>

<div id="diyaOverlay" class="diya-overlay">
    <div class="big-diya-container" id="bigDiyaContainer">
        <i class="fas fa-fire big-diya big-diya-shine" id="theBigDiya"></i>
    </div>
</div>
<div id="travelSpark" class="travel-spark"></div>

<nav>
    <div class="logo-text">Mitraa AI</div>
    <div class="nav-tools">
        <i class="fas fa-spa tool-icon" title="Soul Log" onclick="toggleHistory()"></i>
        <i class="fas fa-leaf tool-icon" title="Zen Mode" onclick="toggleZen()"></i>
        <div class="auth-btns">
            <button class="sign-in">Sign In</button>
            <button class="sign-out">Sign Out</button>
        </div>
    </div>
</nav>

<div class="hero-banner">
    <h1>MITRAA</h1>
    <div class="hero-subtitle">Your Soulful Mindful Companion</div>
</div>

<div class="main-wrapper">
    <div class="wellness-sidebar" id="wellnessSidebar">
        
        <div class="card quote-box">
            <div class="quote-text" id="randomQuote">"Your heart is the size of an ocean. Go find yourself in its hidden depths."</div>
            <div class="quote-author" id="quoteAuthor">‚Äî RUMI</div>
        </div>

        <div class="card">
            <h4>üåø Indian Wellness Corner</h4>
            <div class="mood-selector">
                <i class="fas fa-fire mood-flame active" style="color:#5DA9E9" title="Calm" onclick="selectMood(this, '#5DA9E9', 'Calm Blue')"></i>
                <i class="fas fa-fire mood-flame" style="color:#FF8C00" title="Strength" onclick="selectMood(this, '#FF8C00', 'Strength Saffron')"></i>
                <i class="fas fa-fire mood-flame" style="color:#A3B18A" title="Healing" onclick="selectMood(this, '#A3B18A', 'Growth Green')"></i>
                <i class="fas fa-fire mood-flame" style="color:#CD5C5C" title="Energy" onclick="selectMood(this, '#CD5C5C', 'Root Red')"></i>
            </div>
            <button class="diya-btn" id="diyaButton" onclick="animateDiya()">
                <i class="fas fa-fire" id="smallDiyaIcon"></i> Light a Gratitude Diya
            </button>
            <p id="diyaText" style="font-size: 0.85rem; text-align: center; margin-top: 15px; display: none; color: var(--saffron-bright); font-weight: 700;">You lit a flame of hope today ‚ú®</p>
        </div>

        <div class="card" style="background:#fffcf5;">
            <h4>‚ú® Mood Meanings</h4>
            <div style="font-size:0.8rem; line-height:1.5;">
                <b style="color:#5DA9E9;">Blue:</b> Tranquility & Calm<br>
                <b style="color:#FF8C00;">Saffron:</b> Strength & Courage<br>
                <b style="color:#A3B18A;">Green:</b> Healing & Growth<br>
                <b style="color:#CD5C5C;">Red:</b> Grounding & Awareness
            </div>
        </div>

        <div class="card">
            <h4>ü´Å Pranayama Minute</h4>
            <div id="breathTimer" style="font-size: 2rem; text-align: center; font-weight: 900; color: var(--sage); min-height: 50px;">0</div>
            <div style="height: 14px; background: #eee; border-radius: 10px; overflow: hidden; margin: 15px 0;">
                <div id="breathBar" style="width: 0%; height: 100%; background: var(--sage); transition: 0.1s linear;"></div>
            </div>
            <button onclick="startPranayama()" style="width: 100%; border: none; background: var(--sage); color: white; border-radius: 12px; padding: 12px; font-weight: 700; cursor: pointer;">Start Cycles</button>
        </div>

        <div class="card" style="background: var(--peace-pink); border: 1px solid var(--peace-border); border-left: 5px solid var(--peace-border);">
            <div style="display: flex; align-items: center; gap: 10px;">
                <h4 style="margin: 0;">üå∏ Offering of Peace</h4>
            </div>
            <p style="font-size: 0.85rem; font-style: italic; color: var(--deep-teal); margin-top: 10px;">
                Take a moment to release one thought that no longer serves you.
            </p>
            <button onclick="showerJasmine(this)" 
                    style="width: 100%; border: 1px solid var(--peace-border); background: #fff; color: var(--terracotta); border-radius: 12px; padding: 8px; font-weight: 600; cursor: pointer; margin-top: 5px;">
                Shower Jasmine Petals
            </button>
        </div>

        <div class="card">
            <h4 style="margin-bottom: 10px;">Soulful Reactions</h4>
            <div class="feedback-container">
                <div class="reaction-item">
                    <span class="bling-emoji" onclick="triggerBling(this)">‚ú®</span>
                    <span class="reaction-meaning">Hope</span>
                </div>
                <div class="reaction-item">
                    <span class="bling-emoji" onclick="triggerBling(this)">üßò</span>
                    <span class="reaction-meaning">Peace</span>
                </div>
                <div class="reaction-item">
                    <span class="bling-emoji" onclick="triggerBling(this)">üíñ</span>
                    <span class="reaction-meaning">Loved</span>
                </div>
                <div class="reaction-item">
                    <span class="bling-emoji" onclick="triggerBling(this)">‚òÄÔ∏è</span>
                    <span class="reaction-meaning">Glow</span>
                </div>
            </div>
        </div>

        <div class="card">
            <h4>üìù Soulful Note</h4>
            <textarea class="soul-note" id="soulNoteBox" placeholder="Keep a note of your journey today..." oninput="saveNote()"></textarea>
        </div>

        <div class="card" style="background: #FFF9F2; border: 2px dashed var(--terracotta);">
            <h4 style="color: var(--terracotta);">üÜò Helplines</h4>
            <div style="font-size: 0.8rem; line-height: 1.7;">
                <b>India:</b> 14416 (Tele-MANAS) | 1800-599-0019 <br>
                <b>USA/Canada:</b> 988 | <b>UK:</b> 111 <br>
                <b>Global:</b> befrienders.org
            </div>
        </div>
    </div>

    <div class="chat-container">
        <div class="chat-header">
            <span style="font-weight: 700; color: var(--deep-teal);" id="timeGreeting">Chat with Mitraaa</span>
            <button onclick="clearChat()" style="background:none; border:none; color:var(--terracotta); cursor:pointer; font-size:0.85rem; font-weight:600; text-decoration:underline;">Clear Chat</button>
        </div>
        <div class="chat-messages" id="chatWindow">
            <div class="bubble mitra-bubble">
                <b>Namaste! üôè</b><br> Hii, I am <b>Mitraa</b>, your mitra (friend). I'm so glad you're here. Whether it‚Äôs a tiny worry or a big storm in your heart, I‚Äôm here to listen without judgment. What is on your mind today, dear friend?
            </div>
        </div>
        <div class="chat-input-area">
            <div class="input-row">
                <button id="voiceBtn" class="icon-btn voice-btn" onclick="startVoice()"><i class="fas fa-microphone"></i></button>
                <input type="text" id="userInput" placeholder="Speak your heart out..." onkeypress="checkEnter(event)">
                <button class="icon-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
                <div id="loader" class="rangoli-loader"></div>
            </div>
        </div>
    </div>
</div>

<button class="sos-floating" onclick="alert('Emergency: Call 112 (India) or 911 (USA) immediately.')"><i class="fas fa-heartbeat"></i> SOS EMERGENCY</button>

<script>
    let pranaTune = new Audio('https://ia803102.us.archive.org/21/items/tibetan-bowl-deep/DeepBowl.mp3');
    
    // AUDIO FILE FOR PRANAYAMA
    let pranayamaMusic = new Audio('music.mp3');
    pranayamaMusic.volume = 0.8;

    let localJasmineSound = new Audio('peaceful.mp3'); 
    localJasmineSound.volume = 0.7;

    let moodColor = '#5DA9E9';
    let moodName = "Calm Blue";

    // QUOTES REPOSITORY
    const quotes = [
        { t: "Peace is the highest form of happiness.", a: "Buddha" },
        { t: "The soul always knows what to do to heal itself.", a: "Caroline Myss" },
        { t: "Quiet the mind, and the soul will speak.", a: "Ma Jaya Sati Bhagavati" },
        { t: "Small steps in the right direction can turn out to be the biggest steps of your life.", a: "Anonymous" },
        { t: "You are the sky. Everything else‚Äîit's just the weather.", a: "Pema Ch√∂dr√∂n" }
    ];

    function saveNote() { localStorage.setItem('mitraa_soul_note', document.getElementById('soulNoteBox').value); }

    function initBest() {
        // Load note
        const savedNote = localStorage.getItem('mitraa_soul_note');
        if (savedNote) document.getElementById('soulNoteBox').value = savedNote;
        
        // Load random quote
        const qObj = quotes[Math.floor(Math.random() * quotes.length)];
        document.getElementById('randomQuote').innerText = `"${qObj.t}"`;
        document.getElementById('quoteAuthor').innerText = `‚Äî ${qObj.a.toUpperCase()}`;

        const hour = new Date().getHours();
        document.getElementById('timeGreeting').innerText = (hour < 12 ? "Subhodaya!" : (hour < 17 ? "Namaste!" : "Shubh Sandhya!")) + " Chat with Mitraaa";
    }

    function acceptDisclaimer() { 
        document.getElementById('disclaimerOverlay').style.display = 'none'; 
        // Unlock all audio context
        localJasmineSound.play().then(() => { localJasmineSound.pause(); localJasmineSound.currentTime = 0; }).catch(e => {});
        pranayamaMusic.play().then(() => { pranayamaMusic.pause(); pranayamaMusic.currentTime = 0; }).catch(e => {});
    }

    function selectMood(el, color, name) {
        document.querySelectorAll('.mood-flame').forEach(f => f.classList.remove('active'));
        el.classList.add('active'); 
        moodColor = color; 
        moodName = name;
        document.documentElement.style.setProperty('--mood-color', color);
    }

    function logMood() {
        const list = document.getElementById('historyList');
        const item = document.createElement('div'); item.className = 'history-item';
        item.innerHTML = `<i class="fas fa-fire" style="color:${moodColor}"></i> <span>${moodName} - ${new Date().toLocaleDateString()}</span>`;
        list.prepend(item);
    }

    function triggerBling(el) {
        el.classList.add('bling-active');
        setTimeout(() => el.classList.remove('bling-active'), 600);
    }

    function animateDiya() {
        const overlay = document.getElementById('diyaOverlay'); 
        const bigDiya = document.getElementById('theBigDiya');
        const btn = document.getElementById('diyaButton'); 
        const spark = document.getElementById('travelSpark');
        const icon = document.getElementById('smallDiyaIcon'); 
        const text = document.getElementById('diyaText');
        bigDiya.style.color = moodColor;
        overlay.style.display = 'flex';
        
        // Add specific sparkles to the overlay
        for(let i=0; i<40; i++) { setTimeout(() => createOverlaySparkle(overlay), i * 40); }

        setTimeout(() => {
            bigDiya.style.transition = "all 0.9s cubic-bezier(0.175, 0.885, 0.32, 1.275)";
            bigDiya.style.transform = "scale(0) rotate(360deg)"; bigDiya.style.opacity = "0";
            setTimeout(() => {
                overlay.style.display = 'none'; 
                document.body.classList.add('diya-lit');
                const btnRect = btn.getBoundingClientRect(); 
                spark.style.display = 'block'; spark.style.background = moodColor;
                spark.style.left = '50%'; spark.style.top = '50%';
                createButtonSparkles(btnRect);
                const travel = spark.animate([{ left: '50%', top: '50%', transform: 'scale(1.8)', opacity: 1 }, { left: (btnRect.left + btnRect.width/2) + 'px', top: (btnRect.top + btnRect.height/2) + 'px', transform: 'scale(0.1)', opacity: 0 }], { duration: 850 });
                travel.onfinish = () => {
                    spark.style.display = 'none'; text.style.display = 'block';
                    icon.style.color = moodColor; icon.classList.add('fa-beat');
                    bigDiya.style.transition = "none"; bigDiya.style.transform = "scale(1) rotate(0deg)"; bigDiya.style.opacity = "1";
                    logMood();
                };
            }, 700);
        }, 3000);
    }

    function createOverlaySparkle(parent) {
        const s = document.createElement('div');
        s.className = 'diya-sparkle';
        const angle = Math.random() * Math.PI * 2;
        const radius = Math.random() * 250 + 50;
        s.style.left = `calc(50% + ${Math.cos(angle) * radius}px)`;
        s.style.top = `calc(50% + ${Math.sin(angle) * radius}px)`;
        parent.appendChild(s);
        s.animate([{ transform: 'scale(0)', opacity: 0 }, { transform: 'scale(1.8)', opacity: 1, offset: 0.5 }, { transform: 'scale(0)', opacity: 0 }], { duration: 1500 }).onfinish = () => s.remove();
    }

    function createButtonSparkles(rect) {
        for(let i=0; i<20; i++) {
            const s = document.createElement('div');
            s.className = 'diya-sparkle';
            s.style.left = (rect.left + Math.random() * rect.width) + 'px';
            s.style.top = (rect.top + Math.random() * rect.height) + 'px';
            document.body.appendChild(s);
            s.animate([{ transform: 'translate(0,0)', opacity: 1 }, { transform: `translate(${(Math.random()-0.5)*150}px, ${(Math.random()-0.5)*150}px) scale(0)`, opacity: 0 }], { duration: 1500 }).onfinish = () => s.remove();
        }
    }

    function showerJasmine(btn) {
        btn.innerText = 'Thought Released ‚ú®';
        const sidebar = document.getElementById('wellnessSidebar');
        sidebar.classList.add('sidebar-glow-active');
        localJasmineSound.currentTime = 0;
        localJasmineSound.play().catch(err => { console.log("Sound error"); });
        const count = 80;
        for(let i=0; i<count; i++) {
            setTimeout(() => {
                const type = Math.random();
                if (type < 0.5) createFallingItem('üå∏');
                else if (type < 0.8) createFallingItem('üçÉ');
                else createFallingItem('sparkle');
            }, i * 50);
        }
        setTimeout(() => {
            btn.innerText = 'Shower Jasmine Petals';
            sidebar.classList.remove('sidebar-glow-active');
        }, 8000);
    }

    function createFallingItem(symbol) {
        const item = document.createElement('div');
        item.className = 'falling-item';
        if(symbol === 'sparkle') {
            const s = document.createElement('div');
            s.className = 'sparkle-dot';
            item.appendChild(s);
        } else {
            item.innerHTML = symbol;
            item.style.fontSize = (Math.random() * 15 + 15) + 'px';
        }
        item.style.left = Math.random() * 100 + 'vw';
        item.style.animationDuration = (Math.random() * 3 + 5) + 's';
        item.style.opacity = Math.random() * 0.5 + 0.5;
        document.body.appendChild(item);
        setTimeout(() => item.remove(), 8500);
    }

    function startPranayama() {
        let currentLoop = 1; 
        const totalLoops = 1;
        const breathTime = 9.5; 
        
        const timerDisplay = document.getElementById('breathTimer'); 
        const bar = document.getElementById('breathBar');
        
        pranayamaMusic.currentTime = 0;
        pranayamaMusic.play().catch(e => console.log("Music error"));
        
        document.body.classList.add('pulsing');

        function runCycle() {
            let start = Date.now();
            
            let inhaleTimer = setInterval(() => {
                let elapsed = (Date.now() - start) / 1000;
                let progress = Math.min(elapsed / breathTime, 1);
                let currentCount = Math.floor(elapsed) + 1;
                timerDisplay.innerHTML = `<span style="color: var(--deep-teal)">Inhale</span><br>${currentCount}`;
                bar.style.width = (progress * 100) + "%";

                if (elapsed >= breathTime) {
                    clearInterval(inhaleTimer);
                    let exhaleStart = Date.now();
                    
                    let exhaleTimer = setInterval(() => {
                        let exElapsed = (Date.now() - exhaleStart) / 1000;
                        let exProgress = Math.min(exElapsed / breathTime, 1);
                        let exCount = Math.floor(exElapsed) + 1;
                        timerDisplay.innerHTML = `<span style="color: var(--terracotta)">Exhale</span><br>${exCount}`;
                        bar.style.width = (100 - (exProgress * 100)) + "%";

                        if (exElapsed >= breathTime) {
                            clearInterval(exhaleTimer);
                            if (currentLoop < totalLoops) {
                                currentLoop++;
                                runCycle();
                            } else {
                                timerDisplay.innerText = "Peace";
                                pranayamaMusic.pause();
                                document.body.classList.remove('pulsing');
                                setTimeout(() => { 
                                    timerDisplay.innerText = "0"; 
                                    bar.style.width="0%"; 
                                }, 2000);
                            }
                        }
                    }, 50);
                }
            }, 50);
        }
        runCycle();
    }

    function toggleZen() { document.body.classList.toggle('zen-active'); }
    function toggleHistory() { document.getElementById('moodHistorySidebar').classList.toggle('active'); }
    function clearChat() { document.getElementById('chatWindow').innerHTML = `<div class="bubble mitra-bubble"><b>Namaste! üôè</b><br>I'm ready. How are you feeling now?</div>`; }
    function startVoice() { 
        const btn = document.getElementById('voiceBtn');
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)(); 
        recognition.lang = 'en-IN'; 
        recognition.onstart = () => btn.classList.add('recording');
        recognition.onend = () => btn.classList.remove('recording');
        recognition.onresult = (e) => { document.getElementById('userInput').value = e.results[0][0].transcript; sendMessage(); }; 
        recognition.start(); 
    }
    function sendMessage() {
        const input = document.getElementById('userInput'); const chatWindow = document.getElementById('chatWindow'); const loader = document.getElementById('loader');
        if (input.value.trim() !== "") {
            const uMsg = document.createElement('div'); uMsg.className = 'bubble user-bubble'; uMsg.textContent = input.value;
            chatWindow.appendChild(uMsg); loader.style.display = "block";
            setTimeout(() => {
                loader.style.display = "none"; const mMsg = document.createElement('div'); mMsg.className = 'bubble mitra-bubble';
                mMsg.innerHTML = `<b>Mitraa:</b> I'm here. Let's find clarity.`; chatWindow.appendChild(mMsg);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }, 1500);
            input.value = ""; chatWindow.scrollTop = chatWindow.scrollHeight;
        }
    }
    function checkEnter(e) { if (e.key === 'Enter') sendMessage(); }
</script>
</body>
</html>
